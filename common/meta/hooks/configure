#!/bin/sh

set -e

. "$SNAP/lib/functions.sh"

load_config

if ! SONIC_BACKEND=$(snapctl get backend 2>&1); then
    SONIC_BACKEND=detect
fi

if [ -z "$SONIC_BACKEND" ]; then
    SONIC_BACKEND=detect
fi

case "$SONIC_BACKEND" in
  broadcom|detect|p4)
  ;;
  *)
    echo "Unsupported backend" >&2
    exit 1
  ;;
esac

if ! SONIC_HWSKU=$(snapctl get hwsku 2>&1); then
    SONIC_HWSKU=detect
fi

if [ -z "$SONIC_HWSKU" ]; then
    SONIC_HWSKU=detect
fi

# TODO validate SONIC_HWSKU against available ones

cat >"$SNAP_DATA/config.sh" <<EOF
SONIC_BACKEND=$SONIC_BACKEND
SONIC_HWSKU=$SONIC_HWSKU
EOF

exit 0
